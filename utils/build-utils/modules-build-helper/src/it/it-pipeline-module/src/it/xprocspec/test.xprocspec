<?xml version="1.0" encoding="UTF-8"?>
<x:description xmlns:x="http://www.daisy.org/ns/xprocspec"
               xmlns:p="http://www.w3.org/ns/xproc"
               xmlns:px="http://www.daisy.org/ns/pipeline/xproc"
               xmlns:pxi="http://www.daisy.org/ns/pipeline/xproc/internal"
               xmlns:c="http://www.w3.org/ns/xproc-step"
               xmlns:scr="http://www.osgi.org/xmlns/scr/v1.1.0">
	
	<x:script>
		<p:declare-step type="pxi:dummy" version="1.0">
			<p:sink>
				<p:input port="source">
					<p:empty/>
				</p:input>
			</p:sink>
		</p:declare-step>
	</x:script>
	
	<x:scenario label="test">
		<x:call step="pxi:dummy"/>
		<x:context label="The JAR content">
			<x:document type="zip" href="../../../target/it-pipeline-module-0-SNAPSHOT.jar"/>
		</x:context>
		<x:expect label="The JAR content" type="compare">
			<x:document type="inline">
				<c:zipfile name="it-pipeline-module-0-SNAPSHOT.jar">
					<c:file name="META-INF/MANIFEST.MF"/>
					<c:file name="META-INF/catalog.xml"/>
					<c:file name="META-INF/services/java.lang.Runnable"/>
					<c:file name="META-INF/services/org.daisy.common.spi.CreateOnStart"/>
					<c:file name="META-INF/services/org.daisy.pipeline.datatypes.DatatypeService"/>
					<c:file name="META-INF/services/org.daisy.pipeline.modules.ModuleRef"/>
					<c:file name="META-INF/services/org.daisy.pipeline.script.XProcScriptService"/>
					<c:file name="OSGI-INF/choice.xml"/>
					<c:file name="OSGI-INF/foo-service.xml"/>
					<c:file name="OSGI-INF/org.daisy.pipeline.modules.impl.Module_it_pipeline_module.xml"/>
					<c:file name="OSGI-INF/px-script-option-1.xml"/>
					<c:file name="OSGI-INF/script.xml"/>
					<c:file name="css/foo.css"/>
					<c:file name="data-types/script-option-1.xml"/>
					<c:file name="data-types/type.xml"/>
					<c:file name="impl/JavaStep$1.class"/>
					<c:file name="impl/JavaStep$Provider.class"/>
					<c:file name="impl/JavaStep.class"/>
					<c:file name="org/daisy/impl/Foo.class"/>
					<c:file name="org/daisy/impl/Foo_SPI.class"/>
					<c:file name="org/daisy/pipeline/datatypes/impl/Datatype_px_script_option_1.class"/>
					<c:file name="org/daisy/pipeline/datatypes/impl/Datatype_px_script_option_1_SPI.class"/>
					<c:file name="org/daisy/pipeline/modules/impl/Module_it_pipeline_module.class"/>
					<c:file name="org/daisy/pipeline/modules/impl/Module_it_pipeline_module_SPI.class"/>
					<c:file name="org/daisy/pipeline/script/impl/XProcScript_script.class"/>
					<c:file name="org/daisy/pipeline/script/impl/XProcScript_script_SPI.class"/>
					<c:file name="xml/__processed__script.xpl"/>
					<c:file name="xml/a.xml"/>
					<c:file name="xml/a.xml.xsl"/>
					<c:file name="xml/foo.xpl"/>
					<c:file name="xml/foo.xsl"/>
					<c:file name="xml/library.xpl"/>
					<c:file name="xml/script.xpl"/>
				</c:zipfile>
			</x:document>
		</x:expect>
		<x:context label="The META-INF/catalog.xml file">
			<x:document type="file" href="../../../target/it-pipeline-module-0-SNAPSHOT.jar!/META-INF/catalog.xml"/>
		</x:context>
		<x:expect label="The META-INF/catalog.xml file" type="compare">
			<x:document type="inline">
				<catalog xmlns="urn:oasis:names:tc:entity:xmlns:xml:catalog">
					<uri name="http://www.daisy.org/pipeline/modules/foo-utils/script.xpl" uri="../xml/__processed__script.xpl"/>
					<uri name="http://www.daisy.org/pipeline/modules/foo-utils/library.xpl" uri="../xml/library.xpl"/>
					<uri name="http://www.daisy.org/pipeline/modules/foo-utils/foo.css" uri="../css/foo.css"/>
					<uri name="http://www.daisy.org/pipeline/modules/foo-utils/type.xml" uri="../data-types/type.xml"/>
					<uri name="http://www.daisy.org/pipeline/modules/foo-utils/script.xpl/data-types/script-option-1.xml"
					     uri="../data-types/script-option-1.xml"/>
				</catalog>
			</x:document>
		</x:expect>
		<x:context label="The datatype file">
			<x:document type="file" href="../../../target/it-pipeline-module-0-SNAPSHOT.jar!/data-types/script-option-1.xml"/>
		</x:context>
		<x:expect label="The datatype file" type="compare">
			<x:document type="inline">
				<choice id="px:script-option-1">
					<value>value-1</value>
					<value>value-2</value>
				</choice>
			</x:document>
		</x:expect>
		<x:context label="The datatype DS file">
			<x:document type="file" href="../../../target/it-pipeline-module-0-SNAPSHOT.jar!/OSGI-INF/px-script-option-1.xml"/>
		</x:context>
		<x:expect label="The datatype DS file" type="compare">
			<x:document type="inline">
				<scr:component immediate="true" activate="activate" name="px:script-option-1">
					<implementation class="org.daisy.pipeline.datatypes.impl.Datatype_px_script_option_1"/>
					<service>
						<provide interface="org.daisy.pipeline.datatypes.DatatypeService"/>
					</service>
					<reference bind="setUriResolver" cardinality="1..1"
					           interface="javax.xml.transform.URIResolver" name="URIResolver" policy="static"/>
					<property name="data-type.id" type="String" value="px:script-option-1"/>
					<property name="data-type.url" type="String"
					          value="http://www.daisy.org/pipeline/modules/foo-utils/script.xpl/data-types/script-option-1.xml"/>
				</scr:component>
			</x:document>
		</x:expect>
		<x:context label="The processed script file">
			<x:document type="file" href="../../../target/it-pipeline-module-0-SNAPSHOT.jar!/xml/__processed__script.xpl"/>
		</x:context>
		<x:expect label="The processed script file" type="compare">
			<x:document type="inline">
				<p:declare-step type="px:script" version="1.0">
					<p:documentation xmlns="http://www.w3.org/1999/xhtml">
						<h1 px:role="name">Example script</h1>
						<p px:role="desc">Does stuff.</p>
					</p:documentation>
					<p:input port="source">
						<p:documentation xmlns="http://www.w3.org/1999/xhtml">
							<h1 px:role="name">Source document</h1>
						</p:documentation>
					</p:input>
					<p:option name="option-1" required="true" px:data-type="px:script-option-1">
						<p:documentation xmlns="http://www.w3.org/1999/xhtml">
							<h1 px:role="name">Option 1</h1>
							<p px:role="desc" xml:space="preserve">Enables something.

							For more info see [link](http://example.org/more-info).</p>
						</p:documentation>
					</p:option>
					<p:option name="option-2" required="false" select="'xyz'">
						<p:documentation xmlns="http://www.w3.org/1999/xhtml">
							<h1 px:role="name">Option 2</h1>
						</p:documentation>
					</p:option>
					<p:output port="result"/>
					<p:xslt>
						<p:input port="stylesheet">
							<p:document href="foo.xsl"/>
						</p:input>
						<p:input port="parameters">
							<p:empty/>
						</p:input>
					</p:xslt>
				</p:declare-step>
			</x:document>
		</x:expect>
		<x:context label="The OSGI-INF/script.xml file">
			<x:document type="file" href="../../../target/it-pipeline-module-0-SNAPSHOT.jar!/OSGI-INF/script.xml"/>
		</x:context>
		<x:expect label="The OSGI-INF/script.xml file" type="compare">
			<x:document type="inline">
				<scr:component immediate="true" activate="activate" name="script">
					<implementation class="org.daisy.pipeline.script.impl.XProcScript_script"/>
					<service>
						<provide interface="org.daisy.pipeline.script.XProcScriptService"/>
					</service>
					<property name="script.version" type="String" value="0-SNAPSHOT"/>
					<property name="script.id" type="String" value="script"/>
					<property name="script.description" type="String" value="Does stuff."/>
					<property name="script.url" type="String" value="http://www.daisy.org/pipeline/modules/foo-utils/script.xpl"/>
				</scr:component>
			</x:document>
		</x:expect>
		<x:context label="The OSGI-INF/choice.xml file">
			<x:document type="file" href="../../../target/it-pipeline-module-0-SNAPSHOT.jar!/OSGI-INF/choice.xml"/>
		</x:context>
		<x:expect label="The OSGI-INF/choice.xml file" type="compare">
			<x:document type="inline">
				<scr:component immediate="true" name="foo:choice">
					<scr:implementation class="org.daisy.pipeline.datatypes.UrlBasedDatatypeService"/>
					<scr:service>
						<scr:provide interface="org.daisy.pipeline.datatypes.DatatypeService"/>
					</scr:service>
					<scr:reference bind="setUriResolver" cardinality="1..1" interface="javax.xml.transform.URIResolver" name="resolver" policy="static"/>
					<scr:property name="data-type.id" type="String" value="foo:choice"/>
					<scr:property name="data-type.url" type="String" value="http://www.daisy.org/pipeline/modules/foo-utils/type.xml"/>
				</scr:component>
			</x:document>
		</x:expect>
		<x:context label="The 'doc' JAR content">
			<x:document type="zip" href="../../../target/it-pipeline-module-0-SNAPSHOT-doc.jar"/>
		</x:context>
		<x:expect label="The 'doc' JAR content" type="compare" pending="order of zip entries is undeterministic">
			<x:document type="inline">
				<c:zipfile name="it-pipeline-module-0-SNAPSHOT-doc.jar">
					<c:file name="META-INF/MANIFEST.MF"/>
					<c:file name="src/main/java/allclasses-frame.html"/>
					<c:file name="src/main/java/impl/JavaStep.html"/>
					<c:file name="src/main/java/impl/package-frame.html"/>
					<c:file name="src/main/java/impl/package-summary.html"/>
					<c:file name="src/main/java/index.html"/>
					<c:file name="src/main/java/overview-frame.html"/>
					<c:file name="src/main/java/overview-summary.html"/>
					<c:file name="src/main/resources/META-INF/catalog.xml/index.html"/>
					<c:file name="src/main/resources/css/foo.css/index.md"/>
					<c:file name="src/main/resources/data-types/type.xml/index.html"/>
					<c:file name="src/main/resources/xml/a.xml/index.html"/>
					<c:file name="src/main/resources/xml/foo.xpl/index.html"/>
					<c:file name="src/main/resources/xml/foo.xsl/index.html"/>
					<c:file name="src/main/resources/xml/index.md"/>
					<c:file name="src/main/resources/xml/library.xpl/index.html"/>
					<c:file name="src/main/resources/xml/script.xpl/index.html"/>
				</c:zipfile>
			</x:document>
		</x:expect>
		<x:context label="The 'javadoc' JAR content">
			<x:document type="zip" href="../../../target/it-pipeline-module-0-SNAPSHOT-javadoc.jar"/>
		</x:context>
		<x:expect label="The 'javadoc' JAR contains the JavaStep javadoc" type="xpath" test="/c:zipfile/c:file[@name='impl/JavaStep.html']"/>
		<x:context label="The 'xprocdoc' JAR content">
			<x:document type="zip" href="../../../target/it-pipeline-module-0-SNAPSHOT-xprocdoc.jar"/>
		</x:context>
		<x:expect label="The 'xprocdoc' JAR content" type="compare" pending="order of zip entries is undeterministic">
			<x:document type="inline">
				<c:zipfile name="it-pipeline-module-0-SNAPSHOT-xprocdoc.jar">
					<c:file name="META-INF/MANIFEST.MF"/>
					<c:file name="d191e56.html"/>
					<c:file name="index.html"/>
					<c:file name="libraries.html"/>
					<c:file name="org/daisy/pipeline/modules/foo-utils/library.xpl.html"/>
					<c:file name="org/daisy/pipeline/modules/foo-utils/script.xpl.html"/>
					<c:file name="overview.html"/>
					<c:file name="steps.html"/>
				</c:zipfile>
			</x:document>
		</x:expect>
	</x:scenario>
	
</x:description>
